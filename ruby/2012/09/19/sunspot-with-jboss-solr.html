<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>sunspot 使用 jboss_solr 来代替 sunspot_solr 完成网站搜索 | The Simple</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Jekyll" />
    <meta name="author" content="John" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/style.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <!--[if lt IE 9]>
    <script src="/js/html5.js" type="text/javascript"></script>
    <![endif]-->
</head>
<body id="default">
<div id="head-line"></div>
<div id="content">
    <header id="head">
        <div id="logo">
            <!-- <img src="http://mmistakes.github.io/minimal-mistakes/images/bio-photo.jpg" class="bio-photo" alt=" bio photo"> -->
            <img src="/images/head_portrait.png" class="bio-photo" alt=" bio photo">
            <h2>Simple</h2>
        </div>
        <nav id="nav">
            <ul>
                <li class="fn-clear"><a href="" rel="nofollow" class="action"><i class="icon-home"></i> Home</a></li>
                <li class="fn-clear"><a href="/archives.html"><i class="icon-list-ul"></i> Archives</a></li>
                <li class="fn-clear"><a href="/contact.html"><i class="icon-envelope-alt"></i> Contact</a></li>
                <li class="fn-clear"><a href="http://www.twitter.com/piznlin"><i class="icon-twitter"></i> Twitter</a></li>
            </ul>
        </nav>
    </header>
    <section id="contain">
        <header id="begin">
            <span>2012-09-19 20:16:00 +0800</span>
        </header>
		<article class="post">
    <h1 class="post-title">sunspot 使用 jboss_solr 来代替 sunspot_solr 完成网站搜索</h1>
    <h3>sunspot</h3>

<blockquote>
<p>使用 sunspot + sunspot_solr 非常简单方便的就能完成对网站的搜索，用起来非常简单，插件打包好了一切。让你看不到里面的实现。</p>

<p>sunspot_solr 非常好用是必须要肯定的，但是就是建立索引非常慢，其实这个插件就是模拟了一个 jboss solr，那为什么不直接用这个 java 的 solr 呢？公司其他部门已经搭建完成了一个 solr 搜索引擎了，所以我只要远程调用搜索就 ok。</p>
</blockquote>

<h3>1.部署一个 jboss solr 环境，<a href="http://www.jboss.org/">网址</a>。</h3>

<blockquote>
<p>这里就不详细介绍了。</p>
</blockquote>

<h3>2.增加 sunspot gem 包</h3>

<div class="highlight"><pre><code class="ruby"><span class="n">gem</span> <span class="s1">&#39;sunspot_rails&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sunspot&#39;</span>
</code></pre></div>

<p>Bundle it!
    bundle install</p>

<p>Generate a default configuration file:
    rails generate sunspot_rails:install</p>

<h3>3.增加 searchable block 到你希望索引的 model 里面。</h3>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchable</span> <span class="k">do</span>
    <span class="n">text</span> <span class="ss">:title</span>
    <span class="nb">test</span><span class="ss">:body</span>
    <span class="n">integer</span> <span class="ss">:author_id</span>
    <span class="n">integer</span> <span class="ss">:category_ids</span><span class="p">,</span> <span class="ss">:multiple</span> <span class="o">=&gt;</span> <span class="kp">true</span>
    <span class="n">time</span> <span class="ss">:published_at</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>

<h3>4.配置 solr 的 data-config.xml 文件</h3>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;dataConfig&gt;</span> 
  <span class="nt">&lt;dataSource</span> <span class="na">driver=</span><span class="s">&quot;org.postgresql.Driver&quot;</span>  <span class="na">url=</span><span class="s">&quot;jdbc:postgresql://192.168.5.13/cbb_development:5432&quot;</span>  <span class="na">user=</span><span class="s">&quot;cbb&quot;</span> <span class="na">password=</span><span class="s">&quot;bbc&quot;</span> <span class="na">transactionIsolation=</span><span class="s">&quot;TRANSACTION_READ_COMMITTED&quot;</span> <span class="na">holdability=</span><span class="s">&quot;CLOSE_CURSORS_AT_COMMIT&quot;</span><span class="nt">/&gt;</span> 

  <span class="nt">&lt;document&gt;</span>
    <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;posts&quot;</span> <span class="na">pk=</span><span class="s">&#39;id&#39;</span>
            <span class="na">transformer=</span><span class="s">&quot;RegexTransformer&quot;</span>
            <span class="na">query=</span><span class="s">&quot;select &#39;Product&#39;||&#39; &#39;||id as class_id, &#39;Product&#39; as class_name,  name,language,platform,description,author,developer,add_cbb_time,maintainer from posts&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&#39;class_id&#39;</span> <span class="na">name=</span><span class="s">&#39;id&#39;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&#39;class_name&#39;</span> <span class="na">name=</span><span class="s">&#39;type&#39;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&#39;name&#39;</span> <span class="na">name=</span><span class="s">&#39;name_ss&#39;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&#39;language&#39;</span> <span class="na">name=</span><span class="s">&#39;language_ss&#39;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&#39;platform&#39;</span> <span class="na">name=</span><span class="s">&#39;platform_ss&#39;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&#39;author&#39;</span> <span class="na">name=</span><span class="s">&#39;author_ss&#39;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&#39;developer&#39;</span> <span class="na">name=</span><span class="s">&#39;developer_ss&#39;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&#39;maintainer&#39;</span> <span class="na">name=</span><span class="s">&#39;maintainer&#39;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/entity&gt;</span>

  <span class="nt">&lt;/document&gt;</span>
<span class="nt">&lt;/dataConfig&gt;</span> 
</code></pre></div>

<blockquote>
<p>简单介绍下这里面的配置:</p>

<p>dataSource 就是配置数据库，solr 可以查询到的数据源。</p>

<p>document 一个 core 里面只能配置一个 document。</p>

<p>entity 实体，对应的就是数据库的表或者视图，但是这里面有几个规则，首先就是数据库的 id 要重新加入 Model 名字在前面，和 id 一起变成 entity 的唯一标识。还要设置一个 type 用于区别不同的 Model，也就是区分 entity 用的。</p>

<p>field 就是把数据库中的列对应的变成 solr 里面的 field 的概念，按照我的理解，field 其实也是列的意思。</p>
</blockquote>

<h3>5.配置 schema.xml 文件</h3>

<div class="highlight"><pre><code class="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>

<span class="nt">&lt;schema</span> <span class="na">name=</span><span class="s">&quot;sunspot&quot;</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;types&gt;</span>
    <span class="c">&lt;!-- field type definitions. The &quot;name&quot; attribute is</span>
<span class="c">       just a label to be used by field definitions.  The &quot;class&quot;</span>
<span class="c">       attribute and any other attributes determine the real</span>
<span class="c">       behavior of the fieldType.</span>
<span class="c">         Class names starting with &quot;solr&quot; refer to java classes in the</span>
<span class="c">       org.apache.solr.analysis package.</span>
<span class="c">    --&gt;</span>
    <span class="c">&lt;!-- *** This fieldType is used by Sunspot! *** --&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;string&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.StrField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;tdouble&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.TrieDoubleField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;rand&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.RandomSortField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.TextField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;analyzer</span> <span class="na">type=</span><span class="s">&#39;index&#39;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.SynonymFilterFactory&quot;</span> <span class="na">synonyms=</span><span class="s">&quot;synonyms.txt&quot;</span> <span class="na">ignoreCase=</span><span class="s">&quot;true&quot;</span> <span class="na">expand=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;tokenizer</span> <span class="na">class=</span><span class="s">&quot;org.wltea.analyzer.solr.IKTokenizerFactory&quot;</span> <span class="na">isMaxWordLength=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.LowerCaseFilterFactory&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/analyzer&gt;</span>
      <span class="nt">&lt;analyzer</span> <span class="na">type=</span><span class="s">&#39;query&#39;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.SynonymFilterFactory&quot;</span> <span class="na">synonyms=</span><span class="s">&quot;synonyms.txt&quot;</span> <span class="na">ignoreCase=</span><span class="s">&quot;true&quot;</span> <span class="na">expand=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;tokenizer</span> <span class="na">class=</span><span class="s">&quot;org.wltea.analyzer.solr.IKTokenizerFactory&quot;</span> <span class="na">isMaxWordLength=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.LowerCaseFilterFactory&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/analyzer&gt;</span>
    <span class="nt">&lt;/fieldType&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;boolean&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.BoolField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;date&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.DateField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;sdouble&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.SortableDoubleField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;sint&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.SortableIntField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;slong&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.SortableLongField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;tint&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.TrieIntField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;tfloat&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.TrieFloatField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;tdate&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.TrieDateField&quot;</span> <span class="na">omitNorms=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/types&gt;</span>

  <span class="nt">&lt;fields&gt;</span>
    <span class="c">&lt;!-- Valid attributes for fields:</span>
<span class="c">     name: mandatory - the name for the field</span>
<span class="c">     type: mandatory - the name of a previously defined type from the </span>
<span class="c">       &lt;types&gt; section</span>
<span class="c">     indexed: true if this field should be indexed (searchable or sortable)</span>
<span class="c">     stored: true if this field should be retrievable</span>
<span class="c">     compressed: [false] if this field should be stored using gzip compression</span>
<span class="c">       (this will only apply if the field type is compressable; among</span>
<span class="c">       the standard field types, only TextField and StrField are)</span>
<span class="c">     multiValued: true if this field may contain multiple values per document</span>
<span class="c">     omitNorms: (expert) set to true to omit the norms associated with</span>
<span class="c">       this field (this disables length normalization and index-time</span>
<span class="c">       boosting for the field, and saves some memory).  Only full-text</span>
<span class="c">       fields or fields that need an index-time boost need norms.</span>
<span class="c">     termVectors: [false] set to true to store the term vector for a</span>
<span class="c">       given field.</span>
<span class="c">       When using MoreLikeThis, fields used for similarity should be</span>
<span class="c">       stored for best performance.</span>
<span class="c">     termPositions: Store position information with the term vector.  </span>
<span class="c">       This will increase storage costs.</span>
<span class="c">     termOffsets: Store offset information with the term vector. This </span>
<span class="c">       will increase storage costs.</span>
<span class="c">     default: a value that should be used if no value is specified</span>
<span class="c">       when adding a document.</span>
<span class="c">   --&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;text&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
 
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;type&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;class_name&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;lat&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;lng&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;random_*&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;rand&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;_local*&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;tdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_text&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_texts&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_b&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;boolean&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_bm&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;boolean&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_bs&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;boolean&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_bms&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;boolean&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_d&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;date&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_dm&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;date&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_ds&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;date&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_dms&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;date&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_e&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;sdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_em&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;sdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_es&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;sdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_ems&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;sdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_f&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;sfloat&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_fm&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;sfloat&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_fs&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;sfloat&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_fms&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;sfloat&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_i&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;sint&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_im&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;sint&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_is&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;sint&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_ims&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;sint&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_l&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;slong&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_lm&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;slong&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_ls&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;slong&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_lms&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;slong&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_s&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_sm&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_ss&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_sms&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_it&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;tint&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_itm&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;tint&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_its&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tint&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_itms&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tint&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_ft&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;tfloat&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_ftm&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;tfloat&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_fts&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tfloat&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_ftms&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tfloat&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_dt&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;tdate&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_dtm&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">type=</span><span class="s">&quot;tdate&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_dts&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tdate&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_dtms&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tdate&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_textv&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">termVectors=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_textsv&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">termVectors=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_et&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">termVectors=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_etm&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">termVectors=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_ets&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">termVectors=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*_etms&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">termVectors=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;tdouble&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/fields&gt;</span>
  <span class="c">&lt;!-- Field to use to determine and enforce document uniqueness. </span>
<span class="c">      Unless this field is marked with required=&quot;false&quot;, it will be a required field</span>
<span class="c">   --&gt;</span>
  <span class="nt">&lt;uniqueKey&gt;</span>id<span class="nt">&lt;/uniqueKey&gt;</span>
  <span class="c">&lt;!-- field for the QueryParser to use when an explicit fieldname is absent --&gt;</span>
  <span class="nt">&lt;defaultSearchField&gt;</span>text<span class="nt">&lt;/defaultSearchField&gt;</span>
  <span class="c">&lt;!-- SolrQueryParser configuration: defaultOperator=&quot;AND|OR&quot; --&gt;</span>
  <span class="nt">&lt;solrQueryParser</span> <span class="na">defaultOperator=</span><span class="s">&quot;AND&quot;</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!-- copyField commands copy one field to another at the time a document</span>
<span class="c">        is added to the index.  It&#39;s used either to index the same field differently,</span>
<span class="c">        or to add multiple fields to the same field for easier/faster searching.  --&gt;</span>
<span class="nt">&lt;/schema&gt;</span>
</code></pre></div>

<blockquote>
<p>fieldType 是用来定义 solr 里面的基本数据类型，这些基本数据类型有什么功能，比如是字符串，还是整型，还是 text 可以用来切词 等等</p>

<p>field 这里的 5 个 field 是 sunspot 用来区分不同 Model 的，而且是必要的。</p>

<p>dynamicField 这里的动态字段，是 sunspot 的规则进行查询的，在 data-config.xml 里面，所有从数据库里面到 solr 里面的 field 后面都加了一个后缀。比如一个字符串，并且 solr 存储它，那就写 column<em>ss 第一个 s 就是 string 的意思，第二个 s 是就是 stored 的意思。同理如果是 text 并且存储，就是 column</em>tests。
这些都是 sunspot 自动生成的，不用多少改动。</p>
</blockquote>

<h3>6.搜索</h3>

<div class="highlight"><pre><code class="ruby"><span class="n">result</span> <span class="o">=</span> <span class="no">Sunspot</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="no">Model</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">fulltext</span> <span class="s1">&#39;best pizza&#39;</span>
  <span class="n">with</span> <span class="ss">:blog_id</span><span class="p">,</span> <span class="mi">1</span>
  <span class="n">order_by</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:desc</span>
  <span class="n">paginate</span> <span class="ss">:page</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="mi">15</span>
<span class="k">end</span>
</code></pre></div>

<blockquote>
<p>具体实现去看 <a href="http://sunspot.github.com/">sunspot</a></p>

<p>sunspot <a href="http://sunspot.github.com/docs/index.html">API</a></p>
</blockquote>

    <nav class="pagination-link">
        
        <a class="prev" href="/ruby/2012/09/19/drb-distributed.html" rel="bookmark">&laquo;&nbsp;转自 windy 分布式 DRb 的简介...</a>
        
        
        <a class="next" href="/feeling/2012/09/25/new-super-laptop.html" rel="bookmark">超级本，累死我&nbsp;&raquo;</a>
        
     </nav>
     <div id="disqus_thread"></div>
</article>  

<!-- disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'johnzhao'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
<!-- end_disqus -->
        <footer id="foot">
            <p>&copy; 2013 John Zhao All rights reserved. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/">PIZn</a></p>
        </footer>
    </section>
</div>
<div id="foot-line"></div>
<script src="/js/jquery.js" type="text/javascript"></script>
<script src="/js/jquery.scrollTo.js" type="text/javascript"></script>
<script src="/js/theOne.js" type="text/javascript"></script>

</body>
</html>
